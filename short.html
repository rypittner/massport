<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />
    <title>MassPort â€” Digital Philately & Map</title>
    <link href="https://fonts.googleapis.com/css2?family=Special+Elite&family=Yrsa:wght@500;600&family=Inter:wght@400;600&display=swap" rel="stylesheet" />
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Material+Symbols+Rounded:opsz,wght,FILL,GRAD@20..48,100..700,0..1,-50..200" />
    <style>
        :root {
            --bg: #FCF1E7; --accent: #4478A2; --stamp-red: #C65265;
            --ease-smooth: cubic-bezier(0.2, 0.8, 0.2, 1);
            --r: 20px;
        }
        * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; }
        body {
            margin: 0; font-family: 'Inter', sans-serif; background: var(--bg) url("https://i.ibb.co/RpsfLzc4/88f6ca36fda8.jpg") repeat;
            color: #333; min-height: 100vh; display: flex; flex-direction: column; overflow-x: hidden;
        }
        body.map-active { overflow: hidden; height: 100vh; }
        .header { padding: 40px 20px 0; text-align: center; font-family: 'Yrsa', serif; font-size: 21px; z-index: 10; }
        .tap-zone { position: fixed; top: 0; bottom: 0; width: 15%; z-index: 999; cursor: pointer; }
        .tap-zone.left { left: 0; } .tap-zone.right { right: 0; }

        /* NAVIGATION */
        .collector-nav-container {
            position: fixed; bottom: 25px; left: 50%; transform: translateX(-50%);
            background: rgba(255, 255, 255, 0.98); backdrop-filter: blur(15px);
            padding: 6px; border-radius: 50px; border: 1px solid rgba(0,0,0,0.1);
            box-shadow: 0 10px 40px rgba(0,0,0,0.2); display: flex; align-items: center; z-index: 10000;
        }
        .collector-nav { display: flex; gap: 6px; padding: 4px 10px; overflow-x: auto; scrollbar-width: none; position: relative; }
        .collector-nav::-webkit-scrollbar { display: none; }
        .nav-pill-bg { position: absolute; top: 4px; height: calc(100% - 8px); background: var(--accent); border-radius: 20px; transition: all 0.5s var(--ease-smooth); z-index: 1; pointer-events: none; }
        .nav-tag { font-family: 'Inter', monospace; font-size: 11px; color: #444; cursor: pointer; padding: 8px 14px; border-radius: 20px; white-space: nowrap; z-index: 10; display: flex; align-items: center; }
        .nav-tag span { opacity: 0.6; margin-left: 4px; }
        .nav-tag.active { color: #fff !important; }
        .map-tag { color: var(--accent) !important; font-weight: 700; border: 1.5px solid var(--accent); margin-left: 10px; }
        .map-tag.active { background: var(--accent) !important; color: #fff !important; }

        /* GRID & STAMPS */
        #main-grid {
            display: grid; grid-template-columns: repeat(auto-fit, minmax(220px, 1fr)); gap: 30px;
            max-width: 1100px; margin: 0 auto; padding: 40px 30px 140px; flex-grow: 1; align-items: center;
        }
        @media (max-width: 600px) {
            .header { display: none; }
            #main-grid { display: flex; flex-wrap: nowrap; overflow-x: auto; scroll-snap-type: x mandatory; padding: 0 11vw; width: 100vw; height: 85vh; scrollbar-width: none; }
            .stamp-wrapper { flex: 0 0 78vw; scroll-snap-align: center; }
        }

        .stamp {
            aspect-ratio: 7/9; background: #fff; padding: var(--r); cursor: pointer; position: relative;
            box-shadow: 0 15px 35px rgba(0,0,0,0.1); transform: rotate(var(--r_deg));
            mask: radial-gradient(50% 50%,#0000 66%,#000 67%) round var(--r) var(--r)/calc(2*var(--r)) calc(2*var(--r)), conic-gradient(#000 0 0) content-box;
            -webkit-mask: radial-gradient(50% 50%,#0000 66%,#000 67%) round var(--r) var(--r)/calc(2*var(--r)) calc(2*var(--r)), conic-gradient(#000 0 0) content-box;
        }
        .stamp-image { position: absolute; inset: var(--r); overflow: hidden; border: 4pt solid var(--theme-color); background: var(--theme-color); display: flex; flex-direction: column; justify-content: flex-end; }
        .stamp-image img { position: absolute; inset: 0; width: 100%; height: 100%; object-fit: cover; transition: 0.5s; }
        .stamp-image img.normal { opacity: 0; }
        .is-centered img.normal, .stamp:hover img.normal { opacity: 1; }

        .stamp-title-overlay { position: absolute; bottom: -1px; left: -1px; width: calc(100% + 2px); padding: 12px 10px; background: var(--theme-color); color: #fff; z-index: 5; }
        .stamp-name { font-family: 'Yrsa', serif; font-size: 18px; font-weight: 600; line-height: 1.1; }
        .note-container { display: grid; grid-template-rows: 0fr; transition: 0.5s var(--ease-smooth); overflow: hidden; }
        .is-centered .note-container, .stamp:hover .note-container { grid-template-rows: 1fr; }
        .stamp-note { font-size: 11px; opacity: 0; transition: 0.3s; padding-top: 8px; }
        .is-centered .stamp-note, .stamp:hover .stamp-note { opacity: 1; }

        /* POSTMARK */
        .postmark-seal {
            position: absolute; top: -20px; right: -20px; width: 110px; height: 110px; border: 4px solid var(--stamp-red);
            border-radius: 50%; display: flex; align-items: center; justify-content: center; background: #fff;
            color: var(--stamp-red); font-family: 'Special Elite'; font-size: 11px; z-index: 20; opacity: 0;
            transform: scale(1.5) rotate(var(--seal-rot)); transition: 0.4s var(--ease-smooth); pointer-events: none;
        }
        .is-centered .postmark-seal { opacity: 1; transform: scale(1) rotate(var(--seal-rot)); pointer-events: auto; }
        .postmark-line { width: 80%; height: 1px; background: var(--stamp-red); margin: 3px 0; }

        /* INK STAMPS */
        .ink-stamp { aspect-ratio: 7/9; display: flex; align-items: center; justify-content: center; font-family: 'Special Elite'; color: var(--ink-color); mix-blend-mode: multiply; opacity: 0.8; transition: 0.5s; }
        .ink-stamp-inner { border: 6px double var(--ink-color); padding: 20px; width: 85%; height: 85%; display: flex; flex-direction: column; align-items: center; justify-content: center; }
        .ink-stamp-text-abbr { font-size: 60px; font-weight: 900; line-height: 0.8; }
        .ink-stamp-text-full { font-size: 12px; margin-top: 15px; border-top: 2px solid var(--ink-color); width: 100%; text-align: center; padding-top: 10px; }
        .ink-shape-0 .ink-stamp-inner { border-radius: 50%; border-style: solid; outline: 3px double var(--ink-color); outline-offset: 4px; }
        .ink-shape-1 .ink-stamp-inner { border-radius: 12px; border-style: dashed; }
        .ink-shape-2 .ink-stamp-inner { border-radius: 5px 5px 80px 80px; }

        /* MAP & MODAL */
        #map-container { position: fixed; inset: 0; z-index: 5; opacity: 0; transform: scale(1.05); pointer-events: none; transition: 0.6s var(--ease-smooth); }
        body.map-active #map-container { opacity: 1; transform: scale(1); pointer-events: all; }
        #map { height: 100%; width: 100%; }
        .modal { display: none; position: fixed; inset: 0; background: rgba(0,0,0,0.7); backdrop-filter: blur(8px); z-index: 20000; align-items: center; justify-content: center; color: white; }
        .close { position: absolute; top: 20px; right: 20px; cursor: pointer; background: #000; width: 44px; height: 44px; border-radius: 50%; display: flex; align-items: center; justify-content: center; }
        .modal-city-pill { background: rgba(255,255,255,0.2); padding: 8px 20px; border-radius: 50px; margin-top: 20px; display: inline-flex; gap: 8px; color: #fff; text-decoration: none; font-size: 13px; border: 1px solid rgba(255,255,255,0.3); }
        .placeholder { position: absolute; inset: -1px; background-size: 20px 20px; background-image: repeating-linear-gradient(45deg, rgba(255,255,255,0.2), rgba(255,255,255,0.2) 2px, transparent 2px, transparent 10px); }
    </style>
</head>
<body>
    <div class="header">MassPort</div>
    <div class="tap-zone left" onclick="scrollGrid(-1)"></div>
    <div class="tap-zone right" onclick="scrollGrid(1)"></div>
    <div id="main-grid"></div>

    <div class="collector-nav-container">
        <div class="collector-nav" id="filter-nav"><div class="nav-pill-bg" id="nav-pill"></div></div>
        <div class="nav-tag map-tag" onclick="toggleMap(true)">Map</div>
    </div>
    
    <div id="map-container"><div id="map"></div></div>

    <div id="myModal" class="modal" onclick="this.style.display='none'">
        <span class="close"><span class="material-symbols-rounded">close</span></span>
        <div class="modal-frame" style="max-width:85vw; text-align:center;">
            <img id="img01" style="max-height:60vh; border:10px solid white; box-shadow:0 20px 50px rgba(0,0,0,0.5);">
            <div id="caption" style="margin-top:20px; font-family:'Yrsa';"></div>
        </div>
    </div>

    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <script>
        const TSV_URL = 'https://docs.google.com/spreadsheets/d/e/2PACX-1vSz_zdXMghmyVYL5ugKVPciQ2f9o7vJEPokp1YKS1lZ0_SamkfF40hQlSMYdPhvmlCTlf2ZWojFlo2p/pub?gid=0&single=true&output=tsv';
        const THEMES = ['#4478A2','#C65265','#D78143','#297381','#89974F','#DAAD60','#757498','#AA7876'];
        const INKS = ['#1B4F72', '#78281F', '#186A3B', '#7E5109', '#512E5F'];
        const ABBR = {"AL":"ALABAMA","AK":"ALASKA","AZ":"ARIZONA","AR":"ARKANSAS","CA":"CALIFORNIA","CO":"COLORADO","CT":"CONNECTICUT","DE":"DELAWARE","FL":"FLORIDA","GA":"GEORGIA","HI":"HAWAII","ID":"IDAHO","IL":"ILLINOIS","IN":"INDIANA","IA":"IOWA","KS":"KANSAS","KY":"KENTUCKY","LA":"LOUISIANA","ME":"MAINE","MD":"MARYLAND","MA":"MASSACHUSETTS","MI":"MICHIGAN","MN":"MINNESOTA","MS":"MISSISSIPPI","MO":"MISSOURI","MT":"MONTANA","NE":"NEBRASKA","NV":"NEVADA","NH":"NEW HAMPSHIRE","NJ":"NEW JERSEY","NM":"NEW MEXICO","NY":"NEW YORK","NC":"NORTH CAROLINA","ND":"NORTH DAKOTA","OH":"OHIO","OK":"OKLAHOMA","OR":"OREGON","PA":"PENNSYLVANIA","RI":"RHODE ISLAND","SC":"SOUTH CAROLINA","SD":"SOUTH DAKOTA","TN":"TENNESSEE","TX":"TEXAS","UT":"UTAH","VT":"VERMONT","VA":"VIRGINIA","WA":"WASHINGTON","WV":"WEST VIRGINIA","WI":"WISCONSIN","WY":"WYOMING","EU":"EUROPE"};
        const ICONS = {"AZ":"brightness_7","CA":"beach_access","PA":"notifications_active","EU":"public","NY":"apartment","FL":"sunny","TX":"star","WA":"coffee","HI":"surfing","CO":"mountain_flag","MA":"history_edu"};

        let locs = [], stateInkMap = {}, stateCounts = {}, isAuto = false;

        const haptic = (t = 10) => window.navigator.vibrate?.(t);

        async function init() {
            const r = await fetch(TSV_URL);
            const d = await r.text();
            const rows = d.trim().split('\n').slice(1);
            
            let raw = rows.map(row => {
                const c = row.split('\t');
                let s = c[4]?.split(',').pop().trim().toUpperCase() || 'XX';
                if (!ABBR[s]) s = 'EU';
                return { name: c[0], note: c[2]||'', img: c[3]||'', city: c[4]||'', state: s, type: 'paper' };
            }).sort((a,b) => a.state.localeCompare(b.state));

            let lastS = null, inkIdx = 0;
            raw.forEach(l => {
                if (l.state !== lastS) {
                    stateInkMap[l.state] = INKS[inkIdx % INKS.length];
                    locs.push({ state: l.state, type: 'ink', color: stateInkMap[l.state], idx: inkIdx++ });
                    lastS = l.state;
                }
                locs.push(l);
                stateCounts[l.state] = (stateCounts[l.state] || 0) + 1;
            });

            renderGrid();
            setupNav();
            initMap();
            setupObservers();
        }

        function setupNav() {
            const container = document.getElementById('filter-nav');
            Object.keys(stateCounts).sort().forEach(s => {
                const b = document.createElement('div');
                b.className = 'nav-tag'; b.id = `nav-${s}`;
                b.innerHTML = `${s} <span>(${stateCounts[s]})</span>`;
                b.onclick = () => {
                    isAuto = true; haptic(20); toggleMap(false);
                    document.querySelector(`[data-state="${s}"]`).scrollIntoView({ behavior: 'smooth', block: 'center', inline: 'center' });
                    updatePill(b, stateInkMap[s]);
                    setTimeout(() => isAuto = false, 800);
                };
                container.appendChild(b);
            });
        }

        function updatePill(el, color) {
            document.querySelectorAll('.nav-tag').forEach(t => {
                t.classList.remove('active');
                if(t.id) t.innerHTML = `${t.id.split('-')[1]} <span>(${stateCounts[t.id.split('-')[1]]})</span>`;
            });
            el.classList.add('active');
            if(el.id) el.innerHTML = `${ABBR[el.id.split('-')[1]]} <span>(${stateCounts[el.id.split('-')[1]]})</span>`;
            
            const p = document.getElementById('nav-pill');
            p.style.width = el.offsetWidth + 'px';
            p.style.left = el.offsetLeft + 'px';
            p.style.background = color;
            el.scrollIntoView({ behavior: 'smooth', inline: 'center' });
        }

        function renderGrid() {
            document.getElementById('main-grid').innerHTML = locs.map((l, i) => {
                const rot = (Math.random()*4-2).toFixed(2);
                if (l.type === 'ink') return `
                    <div class="stamp-wrapper" data-state="${l.state}" style="--r_deg:${rot}deg">
                        <div class="ink-stamp ink-shape-${l.idx%3}" style="--ink-color:${l.color}">
                            <div class="ink-stamp-inner">
                                <span class="material-symbols-rounded" style="font-size:40px">${ICONS[l.state]||'explore'}</span>
                                <div class="ink-stamp-text-abbr">${l.state}</div>
                                <div class="ink-stamp-text-full">${ABBR[l.state]}</div>
                            </div>
                        </div>
                    </div>`;
                return `
                    <div class="stamp-wrapper" data-state="${l.state}" style="--r_deg:${rot}deg; --seal-rot:${(Math.random()*40-20)}deg">
                        <div class="stamp" style="--theme-color:${THEMES[i%THEMES.length]}" onclick="openModal(${i})">
                            <div class="stamp-image">
                                ${l.img ? `<img src="${l.img}" class="normal"><img src="${l.img}" style="filter:grayscale(1) sepia(0.5) contrast(1.2)">` : `<div class="placeholder"></div>`}
                                <div class="stamp-title-overlay">
                                    <div class="stamp-name">${l.name}</div>
                                    <div class="note-container"><div class="stamp-note">${l.note}</div></div>
                                </div>
                            </div>
                        </div>
                        <div class="postmark-seal" onclick="event.stopPropagation(); window.open('https://www.google.com/maps/search/?api=1&query=${encodeURIComponent(l.name+','+l.city)}')">
                            <div style="width:80%"><div class="postmark-line"></div>${l.city.split(',')[0]}<div class="postmark-line"></div></div>
                        </div>
                    </div>`;
            }).join('');
        }

        function setupObservers() {
            const obs = new IntersectionObserver(entries => {
                if (isAuto || document.body.classList.contains('map-active')) return;
                entries.forEach(e => {
                    if (e.isIntersecting) {
                        const s = e.target.dataset.state;
                        updatePill(document.getElementById(`nav-${s}`), stateInkMap[s]);
                        haptic(5);
                    }
                });
            }, { threshold: 0.8 });
            document.querySelectorAll('.stamp-wrapper').forEach(w => obs.observe(w));

            const grid = document.getElementById('main-grid');
            grid.onscroll = () => {
                if (window.innerWidth > 600) return;
                document.querySelectorAll('.stamp-wrapper').forEach(w => {
                    const rect = w.getBoundingClientRect();
                    const dist = Math.abs((window.innerWidth/2) - (rect.left + rect.width/2));
                    const isCtr = dist < 50;
                    w.classList.toggle('is-centered', isCtr);
                    w.style.zIndex = isCtr ? "100" : "1";
                });
            };
        }

        function toggleMap(on) {
            haptic(20);
            document.body.classList.toggle('map-active', on);
            document.querySelector('.map-tag').classList.toggle('active', on);
            if(on) document.getElementById('nav-pill').style.opacity = 0;
            else {
                document.getElementById('nav-pill').style.opacity = 1;
                setupObservers();
            }
        }

        function openModal(i) {
            const l = locs[i]; haptic(15);
            document.getElementById('img01').src = l.img;
            document.getElementById('caption').innerHTML = `<h2>${l.name}</h2><p>${l.note}</p>
                <a href="#" class="modal-city-pill">location_on ${l.city}</a>`;
            document.getElementById('myModal').style.display = 'flex';
        }

        function scrollGrid(dir) {
            const g = document.getElementById('main-grid');
            g.scrollBy({ left: (g.offsetWidth * 0.8) * dir, behavior: 'smooth' });
            haptic(10);
        }

        function initMap() {
            const m = L.map('map', { attributionControl: false, zoomControl: false }).setView([38, -97], 4);
            L.tileLayer('https://{s}.basemaps.cartocdn.com/rastertiles/voyager_nolabels/{z}/{x}/{y}{r}.png').addTo(m);
        }

        init();
    </script>
</body>
</html>

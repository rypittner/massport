<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />
<title>MassPort â€” The Collector's Desk</title>

<link href="https://fonts.googleapis.com/css2?family=Special+Elite&family=Yrsa:wght@500;600&family=Inter:wght@400;600&display=swap" rel="stylesheet" />

<style>
:root {
  --bg: #FCF1E7;
  --muted: #6b6b6b;
  --grid-max: 1100px;
  --grid-pad: 20px;
}

* { box-sizing: border-box; -webkit-tap-highlight-color: transparent; }

body {
  margin: 0;
  font-family: 'Inter', sans-serif;
  background: var(--bg) url("https://i.ibb.co/RpsfLzc4/88f6ca36fda8.jpg") repeat;
  color: #333;
  overflow-x: hidden;
  padding-bottom: 120px; /* Space for nav */
}

/* ---------- FLOATING NAVIGATION ---------- */
.collector-nav {
  position: fixed;
  bottom: 25px;
  left: 50%;
  transform: translateX(-50%);
  background: rgba(255, 255, 255, 0.9);
  backdrop-filter: blur(10px);
  padding: 8px 20px;
  border-radius: 50px;
  border: 1px solid rgba(0,0,0,0.1);
  box-shadow: 0 10px 30px rgba(0,0,0,0.15);
  display: flex;
  gap: 12px;
  z-index: 10000;
  max-width: 90vw;
  overflow-x: auto;
  scrollbar-width: none;
  align-items: center;
}
.collector-nav::-webkit-scrollbar { display: none; }

.nav-tag {
  font-family: 'Special Elite', monospace;
  font-size: 13px;
  color: #444;
  text-decoration: none;
  white-space: nowrap;
  cursor: pointer;
  padding: 6px 12px;
  border-radius: 20px;
  transition: all 0.2s;
}
.nav-tag:hover, .nav-tag.active {
  background: #0d72e5;
  color: white;
}

/* ---------- HEADER ---------- */
.header {
  max-width: var(--grid-max);
  margin: 0 auto;
  padding: 40px var(--grid-pad) 20px;
  text-align: center;
}
.header h1 {
  font-family: 'Yrsa', serif;
  font-size: clamp(40px, 8vw, 54px);
  margin: 0;
  letter-spacing: -1px;
}
.header p {
  font-family: 'Special Elite';
  font-size: 14px;
  color: var(--muted);
  margin-top: 5px;
}

/* ---------- ANIMATED GRID ---------- */
.main-desk {
  display: grid;
  grid-template-columns: repeat(4, 1fr);
  gap: 15px;
  max-width: var(--grid-max);
  margin: 0 auto;
  padding: var(--grid-pad);
}

@media (max-width: 850px) { .main-desk { grid-template-columns: repeat(3, 1fr); } }
@media (max-width: 600px) { .main-desk { grid-template-columns: repeat(2, 1fr); } }

/* ---------- STAMP & TOSS ANIMATION ---------- */
.stamp-wrapper {
  opacity: 0;
  transform: translateY(40px) scale(0.9) rotate(calc(var(--r) * 2));
  transition: all 0.7s cubic-bezier(0.175, 0.885, 0.32, 1.275);
}
.stamp-wrapper.visible {
  opacity: 1;
  transform: translateY(0) scale(1) rotate(var(--r));
}

.stamp {
  background: url("https://i.ibb.co/Wp7BDVDy/11bc6ca4cd38.png") center/cover no-repeat;
  padding: 13%;
  aspect-ratio: 151 / 195;
  cursor: pointer;
  transition: transform 0.3s ease;
  position: relative;
}
.stamp:hover { transform: scale(1.08) rotate(0deg) !important; z-index: 50; }

.stamp-image {
  width: 100%; height: 100%;
  position: relative;
  overflow: hidden;
  border: 4pt solid var(--theme-color);
  background: var(--theme-color);
}

.stamp-image img {
  position: absolute; inset: 0;
  width: 100%; height: 100%;
  object-fit: cover;
  transition: opacity 0.3s;
}
img.normal { opacity: 0; }
.stamp:hover img.duotone { opacity: 0; }
.stamp:hover img.normal { opacity: 1; }

/* ---------- THEME ELEMENTS ---------- */
.placeholder {
  position: absolute; inset: 0;
  --light: rgba(255,255,255,0.4);
  --dark: var(--theme-color);
  background-image: repeating-linear-gradient(45deg, var(--light), var(--light) 14px, var(--dark) 14px, var(--dark) 18px);
}

.stamp-title-overlay {
  position: absolute; bottom: 0; width: 100%;
  padding: 10px;
  font-family: 'Yrsa', serif;
  font-size: 16px;
  background: var(--theme-color);
  color: white;
  line-height: 0.9;
}

.postmark-seal {
  position: absolute;
  top: -10px; right: -10px;
  width: 60px; height: 60px;
  border: 1px solid rgba(0,0,0,0.1);
  border-radius: 50%;
  display: flex; align-items: center; justify-content: center;
  font-family: 'Special Elite';
  font-size: 7px; text-align: center;
  transform: rotate(15deg);
  background: rgba(255,255,255,0.2);
  pointer-events: none;
  z-index: 10;
}

/* ---------- MODAL ---------- */
.modal {
  display: none; position: fixed; inset: 0;
  background: rgba(0,0,0,0.92);
  justify-content: center; align-items: center; z-index: 20000;
}
.modal img { max-width: 90vw; max-height: 80vh; border: 10px solid white; }
#caption { position: fixed; bottom: 0; width: 100%; padding: 30px; color: white; text-align: center; background: linear-gradient(transparent, black); }
.close { position: fixed; top: 20px; right: 20px; color: white; font-size: 40px; cursor: pointer; }

</style>
</head>

<body>

<div class="header">
  <h1>MassPort</h1>
  <p>AUTHENTICATED PHILATELY SERVICE</p>
</div>

<div class="collector-nav" id="filter-nav">
  <div class="nav-tag active" onclick="filterState('All', this)">All Archive</div>
</div>

<div class="main-desk" id="main-grid"></div>

<div id="myModal" class="modal">
  <span class="close">&times;</span>
  <img id="img01">
  <div id="caption"></div>
</div>

<script>
const tsvUrl = 'https://docs.google.com/spreadsheets/d/e/2PACX-1vSz_zdXMghmyVYL5ugKVPciQ2f9o7vJEPokp1YKS1lZ0_SamkfF40hQlSMYdPhvmlCTlf2ZWojFlo2p/pub?gid=0&single=true&output=tsv';

const stateNames = { AZ:'Arizona', CA:'California', NM:'New Mexico', NV:'Nevada', UT:'Utah', NE:'Nebraska', MI:'Michigan', MT:'Montana', GA:'Georgia', NJ:'New Jersey', TX:'Texas', IL:'Illinois' };
const themes = ['#4478A2','#C65265','#D78143','#297381','#89974F','#DAAD60','#757498','#AA7876','#D7A995','#6E917A'];

function filterState(state, el) {
  const wrappers = document.querySelectorAll('.stamp-wrapper');
  document.querySelectorAll('.nav-tag').forEach(t => t.classList.remove('active'));
  el.classList.add('active');

  wrappers.forEach(w => {
    if (state === 'All' || w.dataset.state === state) {
      w.style.display = 'block';
      setTimeout(() => w.classList.add('visible'), 50);
    } else {
      w.classList.remove('visible');
      setTimeout(() => w.style.display = 'none', 300);
    }
  });
}

function createStamp(loc) {
  const color = themes[Math.floor(Math.random() * themes.length)];
  const wrapper = document.createElement('div');
  wrapper.className = 'stamp-wrapper';
  wrapper.dataset.state = loc.stateName;
  wrapper.style.setProperty('--r', (Math.random() * 6 - 3).toFixed(2) + 'deg');

  wrapper.innerHTML = `
    <div class="stamp" style="--theme-color: ${color}">
      <div class="postmark-seal">${loc.city.split(',')[0]}<br>RECEIVED</div>
      <div class="stamp-image">
        ${loc.imgUrl ? 
          `<img src="${loc.imgUrl}" class="duotone" loading="lazy">
           <img src="${loc.imgUrl}" class="normal" loading="lazy">` : 
          `<div class="placeholder"></div>`
        }
        <div class="stamp-title-overlay">${loc.name}</div>
      </div>
    </div>
  `;

  wrapper.onclick = () => {
    if (!loc.imgUrl) return;
    const modal = document.getElementById('myModal');
    document.getElementById('img01').src = loc.imgUrl;
    document.getElementById('caption').innerHTML = `<h2 style="font-family:Yrsa">${loc.name}</h2><p>${loc.city}</p>`;
    modal.style.display = 'flex';
  };

  return wrapper;
}

async function init() {
  const response = await fetch(tsvUrl);
  const data = await response.text();
  const rows = data.trim().split('\n').slice(1);

  const locations = rows.map(r => {
    const cols = r.split('\t');
    const rawState = cols[4] ? cols[4].split(',').pop().trim() : 'Other';
    const stateName = ['Italy','Vatican City'].includes(rawState) ? 'Europe' : (stateNames[rawState] || rawState);
    return { name: cols[0], note: cols[2], imgUrl: cols[3] || '', city: cols[4] || '', stateName };
  });

  const grid = document.getElementById('main-grid');
  const nav = document.getElementById('filter-nav');
  const states = new Set();

  locations.forEach(loc => {
    states.add(loc.stateName);
    grid.appendChild(createStamp(loc));
  });

  // Create Nav Tags
  [...states].sort().forEach(s => {
    const btn = document.createElement('div');
    btn.className = 'nav-tag';
    btn.innerText = s;
    btn.onclick = (e) => filterState(s, e.target);
    nav.appendChild(btn);
  });

  // Intersection Observer for the "Toss" animation
  const observer = new IntersectionObserver((entries) => {
    entries.forEach(entry => {
      if (entry.isIntersecting) {
        setTimeout(() => entry.target.classList.add('visible'), 100);
      }
    });
  }, { threshold: 0.1 });

  document.querySelectorAll('.stamp-wrapper').forEach(w => observer.observe(w));
}

document.querySelector('.close').onclick = () => document.getElementById('myModal').style.display = 'none';
document.getElementById('myModal').onclick = (e) => { if(e.target.id === 'myModal') e.target.style.display = 'none'; };

init();
</script>

</body>
</html>

<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0"/>
<title>MassPort â€” Stamp Grid</title>

<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600&family=Yrsa:wght@500&display=swap" rel="stylesheet" />

<style>
:root {
  --bg: #FCF1E7;
  --muted: #6b6b6b;
  --grid-max: calc(220px * 5);
  --grid-pad: 32px;
}

* { box-sizing: border-box; }

body {
  margin: 0;
  font-family: 'Inter', sans-serif;
  background: var(--bg) url("https://i.ibb.co/RpsfLzc4/88f6ca36fda8.jpg") repeat;
}

/* ---------- HEADER ---------- */
.header {
  max-width: var(--grid-max);
  margin: 0 auto;
  padding: 28px var(--grid-pad) 8px;
}
.header h1 {
  font-family: 'Yrsa', serif;
  font-size: 34px;
  margin: 0;
}

/* ---------- STATE HEADER ---------- */
.state-header {
  max-width: var(--grid-max);
  margin: 0 auto;
  padding: 16px var(--grid-pad) 8px;
  font-family: 'Yrsa', serif;
  font-size: 26px;
  cursor: pointer;
  user-select: none;
  display: flex;
  align-items: center;
}
.state-header span {
padding-left:5px;
  font-family: 'Inter', sans-serif;
  font-size: 14px;
  color: var(--muted);
}

/* ---------- GRID ---------- */
.grid-wrapper {
  overflow: hidden;
  transition: max-height 0.3s ease-out;
}
.grid-wrapper.collapsed {
  max-height: 0 !important;
}

.grid {
  display: grid;
  grid-template-columns: repeat(4, 1fr);
  gap: 0px;
  padding: var(--grid-pad);
  max-width: var(--grid-max);
  margin: 0 auto;
}

/* Responsive breakpoints */
@media (max-width: 768px) { .grid { grid-template-columns: repeat(3, 1fr); } }
@media (max-width: 640px)  { .grid { grid-template-columns: repeat(2, 1fr); } }

/* ---------- STAMP ---------- */
.stamp {
  background: url("https://i.ibb.co/Wp7BDVDy/11bc6ca4cd38.png") center/cover no-repeat;
  padding: 13%;
  aspect-ratio: 151 / 195;
  display: flex;
  cursor: pointer;
  --theme-color: #0d72e5;
  transition: transform 0.3s ease;
}
.stamp:hover {
  transform: scale(1.05) rotate(var(--rot));
}

/* ---------- IMAGE ---------- */
.stamp-image {
  flex: 1;
  position: relative;
  overflow: hidden;
  border: 4pt solid var(--theme-color);
  background: var(--theme-color);
}

/* real images */
.stamp-image img {
  position: absolute;
  inset: 0;
  width: 100%;
  height: 100%;
  object-fit: cover;
  /*transition: opacity 0.3s ease;*/
}
img.normal { opacity: 0; }
.stamp-image:hover img.duotone { opacity: 0; }
.stamp-image:hover img.normal { opacity: 1; }

/* ---------- PLACEHOLDERS ---------- */
.placeholder {
  position: absolute;
  inset: 0;
  --light: rgba(255,255,255,0.4);
  --dark: var(--theme-color);
  background-image: repeating-linear-gradient(
    var(--stripe-angle),
    var(--stripe-light),
    var(--stripe-light) 14px,
    var(--stripe-dark) 14px,
    var(--stripe-dark) 18px
  );
  transition: background-image 0.3s ease, --stripe-light 0.3s ease, --stripe-dark 0.3s ease;
}

.pattern-1 { --stripe-angle: 45deg;  --stripe-light: var(--light); --stripe-dark: var(--dark); }
.pattern-2 { --stripe-angle: 135deg; --stripe-light: var(--dark); --stripe-dark: var(--light); }
.pattern-3 { --stripe-angle: 135deg; --stripe-light: var(--light); --stripe-dark: var(--dark); }
.pattern-4 { --stripe-angle: 45deg;  --stripe-light: var(--dark); --stripe-dark: var(--light); }

.stamp-image:hover .placeholder {
  --stripe-light: var(--dark);
  --stripe-dark: var(--light);
}

/* ---------- TITLE ---------- */
.stamp-title-overlay {
  position: absolute;
  bottom: 0;
  width: 100%;
  padding: 15px;
  font-family: 'Yrsa', serif;
  font-size: 125%;
  background: color-mix(in srgb, var(--theme-color) 90%, transparent);
  color: white;
  line-height:0.9;
}
.stamp-image:hover .stamp-title-overlay {
  background: white;
  color: var(--theme-color);
}

/* ---------- LOCATION ---------- */
.stamp-location {
  position: absolute;
  top: 8px;
  right: 0;
  background: var(--theme-color);
  color: white;
  font-size: 10px;
  padding: 2px 6px;
  border-radius: 10px 0 0 10px;
  text-transform:uppercase;
  letter-spacing:0.6px;
}

/* ---------- MODAL ---------- */
.modal {
  display: none;
  position: fixed;
  inset: 0;
  background: rgba(0,0,0,0.9);
  justify-content: center;
  align-items: center;
  z-index: 10000;
}
.modal img {
  max-width: 90vw;
  max-height: 85vh;
}
#caption {
  position: fixed;
  bottom: 0;
  width: 100%;
  background: rgba(0,0,0,0.9);
  color: white;
  text-align: center;
  padding: 20px;
}
.close {
  position: fixed;
  top: 10px;
  right: 10px;
  font-size: 40px;
  color: white;
  cursor: pointer;
}
.modal-city {
  font-size: 12px;
  margin-left: 8px;
  background: rgba(255,255,255,0.2);
  padding: 4px 8px;
  border-radius: 8px;
    text-transform:uppercase;
  letter-spacing:0.6px;
}
</style>
</head>

<body>
<div class="header"><h1>MassPort</h1></div>
<div id="content"></div>

<div id="myModal" class="modal">
  <span class="close">&times;</span>
  <img id="img01">
  <div id="caption"></div>
</div>

<script>
const tsvUrl =
'https://docs.google.com/spreadsheets/d/e/2PACX-1vSz_zdXMghmyVYL5ugKVPciQ2f9o7vJEPokp1YKS1lZ0_SamkfF40hQlSMYdPhvmlCTlf2ZWojFlo2p/pub?gid=0&single=true&output=tsv';

const stateNames = {
  AZ:'Arizona', CA:'California', NM:'New Mexico', NV:'Nevada',
  UT:'Utah', NE:'Nebraska', MI:'Michigan', MT:'Montana',
  GA:'Georgia', NJ:'New Jersey', TX:'Texas', IL:'Illinois'
};

const themes = [
  '#4478A2','#C65265','#D78143','#297381','#89974F',
  '#DAAD60','#757498','#AA7876','#D7A995','#6E917A'
];

let themeIndex = 0;
let placeholderIndex = 0;

function createStamp(loc) {
  const color = themes[themeIndex++ % themes.length];
  const stamp = document.createElement('div');
  stamp.className = 'stamp';
  stamp.style.setProperty('--theme-color', color);

  const rot = (Math.random() * 6 - 3).toFixed(2) + 'deg';
  stamp.style.setProperty('--rot', rot);

  const img = document.createElement('div');
  img.className = 'stamp-image';

  if (loc.imgUrl) {
    const d = document.createElement('img');
    d.src = loc.imgUrl;
    d.className = 'duotone';

    const n = document.createElement('img');
    n.src = loc.imgUrl;
    n.className = 'normal';

    img.append(d, n);
  } else {
    const ph = document.createElement('div');
    ph.className = `placeholder pattern-${(placeholderIndex++ % 4) + 1}`;
    img.appendChild(ph);
  }

  const title = document.createElement('div');
  title.className = 'stamp-title-overlay';
  title.textContent = loc.name;

  const locTag = document.createElement('div');
  locTag.className = 'stamp-location';
  locTag.textContent = loc.city;

  img.append(locTag, title);
  stamp.appendChild(img);

  stamp.onclick = () => {
    if (!loc.imgUrl) return;
    myModal.style.display = 'flex';
    img01.src = loc.imgUrl;
    caption.innerHTML = `${loc.name}<span class="modal-city">${loc.city}</span>`;
  };

  return stamp;
}

function mixStamps(locs) {
  const images = locs.filter(l => l.imgUrl);
  const placeholders = locs.filter(l => !l.imgUrl);
  const mixed = [];
  const maxLength = Math.max(images.length, placeholders.length);
  for (let i = 0; i < maxLength; i++) {
    if (images[i]) mixed.push(images[i]);
    if (placeholders[i]) mixed.push(placeholders[i]);
  }
  return mixed;
}

(async function init() {
  const rows = (await (await fetch(tsvUrl)).text()).trim().split('\n').slice(1);

  const locations = rows.map(r => {
    const [name,, , imgUrl, city] = r.split('\t');
    return { name, imgUrl: imgUrl || '', city, raw: city.split(',').pop().trim() };
  });

  const groups = {};
  locations.forEach(l => {
    const key = ['Italy','Vatican City'].includes(l.raw)
      ? 'Europe'
      : stateNames[l.raw] || l.raw;
    (groups[key] ||= []).push(l);
  });

  const finalGroups = { Europe: groups.Europe || [], Other: [] };
  Object.entries(groups).forEach(([state, locs]) => {
    if (state === 'Europe') return;
    locs.length === 1
      ? finalGroups.Other.push(...locs)
      : finalGroups[state] = locs;
  });

  const entries = Object.entries(finalGroups)
    .filter(([k]) => k !== 'Other')
    .sort((a,b) => b[1].length - a[1].length || a[0].localeCompare(b[0]));

  if (finalGroups.Other.length) entries.push(['Other', finalGroups.Other]);

  const content = document.getElementById('content');

  entries.forEach(([state, locs]) => {
    const h = document.createElement('div');
    h.className = 'state-header';
    h.innerHTML = `${state} <span>(${locs.length})</span>`;

    const wrap = document.createElement('div');
    wrap.className = 'grid-wrapper';
    wrap.style.maxHeight = `${locs.length * 250}px`; // initial height

    const g = document.createElement('div');
    g.className = 'grid';

    const mixed = mixStamps(locs);
    mixed.forEach(l => g.appendChild(createStamp(l)));

    h.addEventListener('click', () => {
      if (wrap.classList.contains('collapsed')) {
        wrap.classList.remove('collapsed');
        wrap.style.maxHeight = `${wrap.scrollHeight}px`;
      } else {
        wrap.style.maxHeight = '0';
        wrap.classList.add('collapsed');
      }
    });

    wrap.appendChild(g);
    content.append(h, wrap);
  });
})();

/* MODAL CONTROLS */
const myModal = document.getElementById('myModal');
const img01 = document.getElementById('img01');
const caption = document.getElementById('caption');
const closeBtn = document.querySelector('.close');

closeBtn.onclick = () => myModal.style.display = 'none';
myModal.onclick = e => e.target === myModal && (myModal.style.display = 'none');
</script>
</body>
</html>
